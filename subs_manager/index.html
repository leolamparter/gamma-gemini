<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Manager - Finance Forward GAMMA</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,0&icon_names=adddashboardinforeceipt_longsettingsmenugavelloginlogoutaccount_circlebar_chartlistsubscriptionsdeletewarningcloseadd_circleeventcalendar_monthtodayedit"/>
    <link rel="icon" type="image/x-icon" href="../src/fflogo.jpg">
    <link rel="stylesheet" href="./subscription-manager_gamma.css">

    <script defer src="../firestore.js" type="module"></script>
    <audio src="../src/Tink.mp3" id="success-audio"></audio>
    <audio src="../src/Sosumi.mp3" id="fail-audio"></audio>
</head>
<body>
    <header class="header">
       <button class="header__menu-toggle" id="menu-toggle" aria-label="Toggle menu">
           <img class="header__icon header__icon--menu" src="../src/icons/menu.png" alt="Menu">
       </button>
       <div class="header__title">
           Finance Forward <span class="header__version-badge">GAMMA GEMINI 1.0</span>
       </div>
       <div class="header__actions">
           <a href="../add-receipt" class="header__action-link" aria-label="Add Receipt">
               <img src="../src/icons/add.png" alt="Add Receipt" class="header__icon">
           </a>
           <img class="header__icon header__icon--logo" src="../src/fflogo.jpg" alt="Finance Forward Logo">
       </div>
    </header>

    <nav class="sidebar" id="sidebar">
       <h1 class="sidebar__title">Finance Forward</h1>
       <ul class="sidebar__nav-list">
           <li class="sidebar__nav-item"><a href="../add-receipt"><img src="../src/icons/add.png" alt=""> Add Receipt</a></li>
           <li class="sidebar__nav-item"><a href="../report"><img src="../src/icons/receipt_long.png" alt=""> Report</a></li>
           <li class="sidebar__nav-item"><a href="../links"><img src="../src/icons/log.png" alt=""> More Links</a></li>
       </ul>
       <button class="sidebar__button sidebar__button--signin" id="signin-button">Sign In</button>
       <div class="sidebar__footer">
           <a href="../settings/" class="sidebar__footer-link"><img src="../src/icons/settings.png" alt=""> Account</a>
           <a href="../legal/" class="sidebar__footer-link"><img src="../src/icons/gavel.png" alt=""> Legal</a>
           <a href="../beta/dashboard/" class="sidebar__footer-link"><span>Î²</span> Use BETA dashboard</a>
       </div>
    </nav>

    <main class="main-content" id="main-content">
        <h1 class="page-title">Subscription Manager</h1>

        <section class="settings-card">
            <h2 class="settings-card__title">
                <span class="material-symbols-outlined">add_circle</span>
                Add New Subscription
            </h2>
            <form class="add-subscription-form" id="add-subscription-form">
                <div class="form-row">
                    <div class="form-group form-group--half">
                        <label for="sub-name" class="form-label">Subscription Name</label>
                        <input type="text" id="sub-name" class="form-input" placeholder="e.g., Streaming Service" required>
                    </div>
                    <div class="form-group form-group--half">
                        <label for="sub-price" class="form-label">Amount per Cycle</label>
                        <input type="number" id="sub-price" class="form-input" placeholder="e.g., 15.99" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form-group--half">
                        <label for="sub-frequency" class="form-label">Frequency</label>
                        <select id="sub-frequency" class="form-select" required>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group form-group--half frequency-details" id="frequency-details-container">
                        <div class="frequency-detail frequency-detail--weekly" id="weekly-detail">
                            <label for="sub-detail-dow" class="form-label">Day of Week</label>
                            <select id="sub-detail-dow" class="form-select">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="frequency-detail frequency-detail--monthly" id="monthly-detail">
                            <label for="sub-detail-dom" class="form-label">Day of Month</label>
                            <input id="sub-detail-dom" type="number" class="form-input" min="1" max="31" placeholder="e.g., 15">
                             </div>
                         <div class="frequency-detail frequency-detail--yearly" id="yearly-detail">
                             <label for="sub-detail-date" class="form-label">Date (Month & Day)</label>
                             <input id="sub-detail-date" type="date" class="form-input">
                             </div>
                    </div>
                </div>
                <p class="form-error form-error--hidden" id="add-subscription-error"></p>
                <button type="submit" class="form-button" id="add-subscription-button">
                    <span class="form-button__text">Add Subscription</span>
                    <span class="form-button__loader"></span>
                </button>
            </form>
        </section>

        <section class="settings-card">
             <h2 class="settings-card__title">
                <span class="material-symbols-outlined">subscriptions</span>
                Your Subscriptions
            </h2>

            <div class="loading-indicator loading-indicator--hidden" id="loading-indicator">
                <div class="loading-indicator__spinner"></div>
                <span>Loading subscriptions...</span>
            </div>

            <div class="subscription-list" id="subscription-list-container">
                </div>

            <p class="empty-message empty-message--hidden" id="empty-message">
                You haven't added any subscriptions yet.
            </p>
        </section>

    </main>

    <div class="popup-overlay popup-overlay--hidden" id="remove-confirmation-overlay">
        <div class="popup" id="remove-confirmation-popup">
            <button class="popup__close-button" id="remove-confirmation-cancel-button" aria-label="Close">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 class="popup__title" id="remove-confirmation-title">
                 <span class="material-symbols-outlined">warning</span> Confirmation
            </h2>
            <div class="popup__content">
                <p id="remove-confirmation-message">Are you sure?</p>
                <div id="remove-confirmation-details" class="confirmation-details"></div> </div>
            <div class="popup__actions">
                 <button type="button" class="form-button form-button--secondary" id="remove-confirmation-cancel-button-alt">Cancel</button>
                 <button type="button" class="form-button form-button--danger" id="remove-confirmation-proceed-button">
                    <span class="form-button__text">Proceed</span>
                    <span class="form-button__loader"></span>
                 </button>
            </div>
        </div>
    </div>

    <div class="popup-overlay popup-overlay--hidden" id="edit-subscription-overlay">
        <div class="popup popup--edit" id="edit-subscription-popup">
             <button class="popup__close-button" id="edit-popup-close-button" aria-label="Close">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 class="popup__title">Edit Subscription</h2>
            <form id="edit-subscription-form">
                <input type="hidden" id="edit-sub-original-name">

                <div class="form-group">
                    <label for="edit-sub-name" class="form-label">Subscription Name</label>
                    <input type="text" id="edit-sub-name" class="form-input" required>
                </div>
                 <div class="form-group">
                    <label for="edit-sub-price" class="form-label">Amount per Cycle</label>
                    <input type="number" id="edit-sub-price" class="form-input" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-sub-frequency" class="form-label">Frequency</label>
                    <select id="edit-sub-frequency" class="form-select" required>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group frequency-details" id="edit-frequency-details-container">
                    <div class="frequency-detail frequency-detail--weekly" id="edit-weekly-detail">
                        <label for="edit-sub-detail-dow" class="form-label">Day of Week</label>
                        <select id="edit-sub-detail-dow" class="form-select">
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="frequency-detail frequency-detail--monthly" id="edit-monthly-detail">
                        <label for="edit-sub-detail-dom" class="form-label">Day of Month</label>
                        <input id="edit-sub-detail-dom" type="number" class="form-input" min="1" max="31">
                    </div>
                    <div class="frequency-detail frequency-detail--yearly" id="edit-yearly-detail">
                         <label for="edit-sub-detail-date" class="form-label">Date (Month & Day)</label>
                         <input id="edit-sub-detail-date" type="date" class="form-input">
                    </div>
                </div>
                 <p class="form-error form-error--hidden" id="edit-subscription-error"></p>
                <div class="popup__actions">
                     <button type="button" class="form-button form-button--secondary" id="edit-popup-cancel-button">Cancel</button>
                     <button type="submit" class="form-button" id="edit-popup-save-button">
                        <span class="form-button__text">Save Changes</span>
                        <span class="form-button__loader"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script src="./subscription-manager_gamma.js" defer type="module"></script>
</body>
</html>
<style>
/* subscription-manager_gamma.css */

/* --- Base Styles & Variables (Consistent) --- */
:root {
   /* Color Palette */
   --color-background: #000000;
   --color-text: #FFFFFF;
   --color-text-muted: #a0a0a0;
   --color-header-bg: #838383;
   --color-sidebar-bg: #2F2C27;
   --color-card-bg: #2F2C27;
   --color-dashboard-bg: #1E1E1E;
   --color-input-bg: #3E3A34;
   --color-primary-accent: #FF9B07;
   --color-primary-accent-hover: #e68a00;
   --color-border-subtle: #4a4a4a;
   --color-danger: #f44336;
   --color-danger-hover: #da190b;
   --color-info: #2196F3; /* Added for edit button */
   --color-info-hover: #0b7dda;
   --color-disabled: #5a5a5a;
   --color-overlay-bg: rgba(0, 0, 0, 0.75);

   /* Font */
   --font-family-base: 'Manrope', sans-serif;

   /* Spacing */
   --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem;
   --space-lg: 1.5rem; --space-xl: 2rem; --space-xxl: 3rem;

   /* Sizes */
   --header-height: 60px;
   --sidebar-width: 250px;
   --input-height: 50px;
   --button-height: 50px;
   --action-button-height: 36px; /* Smaller Edit/Remove buttons */

   /* Transitions */
   --transition-speed: 0.3s;
   --transition-ease: ease;

   /* Borders */
   --border-radius-sm: 4px;
   --border-radius-md: 8px;
   --border-radius-lg: 25px;
}

/* Reset */
* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; }
body {
    font-family: var(--font-family-base);
    background-color: var(--color-dashboard-bg);
    color: var(--color-text);
    line-height: 1.6;
    overflow-x: hidden;
}
a { text-decoration: none; color: inherit; transition: color var(--transition-speed) var(--transition-ease); }
img { max-width: 100%; height: auto; display: block; }
button {
    font-family: inherit; font-size: inherit; cursor: pointer; border: none;
    background-color: transparent; color: inherit; padding: 0;
    border-radius: var(--border-radius-lg);
    transition: background-color var(--transition-speed) var(--transition-ease),
                opacity var(--transition-speed) var(--transition-ease),
                transform var(--transition-speed) var(--transition-ease);
}
label { display: block; margin-bottom: var(--space-sm); font-weight: 700; text-align: left; }
input, select, button { font-family: inherit; font-size: 1rem; }

/* --- Header (Consistent) --- */
.header { /* ... (Same as previous pages) ... */
   background-color: var(--color-header-bg); color: var(--color-text);
   display: flex; justify-content: space-between; align-items: center;
   padding: 0 var(--space-md); height: var(--header-height);
   position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
   box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.header__menu-toggle { display: none; background: none; border: none; padding: var(--space-sm); margin-right: var(--space-sm); }
.header__title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: var(--space-sm); }
.header__version-badge { background-color: var(--color-sidebar-bg); color: var(--color-primary-accent); padding: var(--space-xs) var(--space-sm); font-size: 0.8rem; border-radius: var(--border-radius-sm); font-weight: 700; text-transform: uppercase; }
.header__actions { display: flex; align-items: center; gap: var(--space-md); }
.header__action-link { display: flex; align-items: center; }
.header__icon { width: 25px; height: 25px; transition: opacity var(--transition-speed) var(--transition-ease); }
.header__icon:hover { opacity: 0.8; }
.header__icon--logo { width: 40px; height: 40px; }
.header__icon--menu { width: 30px; height: 30px; }

/* --- Sidebar (Consistent) --- */
.sidebar { /* ... (Same as previous pages) ... */
   background-color: var(--color-sidebar-bg); width: var(--sidebar-width);
   height: 100vh; position: fixed; top: 0; left: 0;
   padding: var(--space-lg); padding-top: calc(var(--header-height) + var(--space-lg));
   overflow-y: auto; z-index: 900; transition: transform var(--transition-speed) var(--transition-ease);
   display: flex; flex-direction: column;
}
.sidebar__title { font-size: 1.5rem; margin-bottom: var(--space-xl); font-weight: 700; color: var(--color-text); }
.sidebar__nav-list { flex-grow: 1; }
.sidebar__nav-item { margin-bottom: var(--space-sm); }
li::marker { content: ''; }
.sidebar__nav-item a, .sidebar__footer-link { color: var(--color-text); padding: var(--space-sm) var(--space-md); display: flex; align-items: center; gap: var(--space-md); font-size: 1.125rem; border-radius: var(--border-radius-md); transition: color var(--transition-speed) var(--transition-ease), background-color var(--transition-speed) var(--transition-ease); }
.sidebar__nav-item a img, .sidebar__footer-link img, .sidebar__footer-link span { width: 20px; height: 20px; opacity: 0.8; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; }
.sidebar__nav-item a:hover, .sidebar__footer-link:hover { color: var(--color-primary-accent); background-color: rgba(255, 255, 255, 0.05); }
.sidebar__nav-item a:hover img, .sidebar__footer-link:hover img, .sidebar__footer-link:hover span { opacity: 1; }
.sidebar__button { background-color: var(--color-primary-accent); color: var(--color-text); border: none; padding: var(--space-sm) var(--space-md); width: 100%; margin-top: var(--space-lg); text-align: center; font-weight: 700; font-size: 1rem; }
.sidebar__button:hover { background-color: var(--color-primary-accent-hover); }
.sidebar__footer { margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--color-border-subtle); }
.sidebar__footer-link { margin-top: var(--space-sm); font-size: 1rem; }
.sidebar--active { transform: translateX(0); }

/* --- Main Content Area --- */
.main-content {
   margin-top: var(--header-height);
   margin-left: var(--sidebar-width);
   padding: var(--space-xl);
   background-color: var(--color-dashboard-bg);
   min-height: calc(100vh - var(--header-height));
   transition: margin-left var(--transition-speed) var(--transition-ease);
}

.page-title {
    font-size: 2rem;
    margin-bottom: var(--space-xl);
    color: var(--color-text);
}

/* --- Settings Card Layout (Reused) --- */
.settings-card {
    background-color: var(--color-card-bg);
    padding: var(--space-xl);
    border-radius: var(--border-radius-md);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    margin-bottom: var(--space-xl);
    opacity: 0; transform: translateY(20px);
    animation: fadeInCard 0.5s var(--transition-ease) forwards;
}
.settings-container > .settings-card:nth-child(1) { animation-delay: 0.1s; }
.settings-container > .settings-card:nth-child(2) { animation-delay: 0.2s; }
@keyframes fadeInCard { to { opacity: 1; transform: translateY(0); } }

.settings-card__title {
    font-size: 1.5rem; margin-bottom: var(--space-lg); color: var(--color-primary-accent);
    display: flex; align-items: center; gap: var(--space-sm);
    border-bottom: 1px solid var(--color-border-subtle); padding-bottom: var(--space-sm);
}
.settings-card__title .material-symbols-outlined { font-size: 1.8rem; }
.settings-card__description { font-size: 0.95rem; color: var(--color-text-muted); margin-bottom: var(--space-lg); line-height: 1.5; }

/* --- Add Subscription Form --- */
.add-subscription-form { display: flex; flex-direction: column; gap: var(--space-lg); }
.form-row { display: flex; flex-wrap: wrap; gap: var(--space-lg); }
.form-group { flex: 1; min-width: 150px; text-align: left; }
.form-group--half { flex-basis: calc(50% - (var(--space-lg) / 2)); }
.form-label { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: var(--space-xs); }
.form-input, .form-select {
    width: 100%; padding: 0 var(--space-md); height: var(--input-height); line-height: var(--input-height);
    border: 1px solid var(--color-border-subtle); border-radius: var(--border-radius-md);
    color: var(--color-text); background-color: var(--color-input-bg); font-size: 1rem;
    transition: border-color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
}
.form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary-accent); box-shadow: 0 0 0 3px rgba(255, 155, 7, 0.3); }
.form-input::placeholder { color: var(--color-text-muted); opacity: 0.8; }
.form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' width='16' height='16' fill='%23a0a0a0' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right var(--space-md) center; background-size: 1em; padding-right: calc(var(--space-md) * 3); }
.form-select option { background-color: var(--color-input-bg); color: var(--color-text); }

/* Frequency Specific Inputs */
.frequency-details { position: relative; min-height: calc(var(--input-height) + var(--space-sm) + 1em); }
.frequency-detail { display: none; }
.frequency-details--show-weekly #weekly-detail,
.frequency-details--show-monthly #monthly-detail,
.frequency-details--show-yearly #yearly-detail { display: block; animation: fadeInDetail 0.3s ease forwards; }
@keyframes fadeInDetail { from { opacity: 0; } to { opacity: 1; } }

/* Add Form Button */
.add-subscription-form .form-button { height: var(--button-height); min-width: 200px; align-self: flex-start; border-radius: var(--border-radius-md); }

/* --- Subscription List --- */
.subscription-list { list-style: none; padding: 0; margin-top: var(--space-lg); display: flex; flex-direction: column; gap: var(--space-md); }
.subscription-item {
    background-color: var(--color-input-bg); padding: var(--space-md); border-radius: var(--border-radius-sm);
    border: 1px solid var(--color-border-subtle); display: flex; justify-content: space-between;
    align-items: center; gap: var(--space-md); opacity: 0; transform: translateX(-20px);
    animation: slideInItem 0.4s ease forwards;
}
.subscription-item:nth-child(1) { animation-delay: 0.05s; }
.subscription-item:nth-child(2) { animation-delay: 0.1s; }
.subscription-item:nth-child(3) { animation-delay: 0.15s; }
@keyframes slideInItem { to { opacity: 1; transform: translateX(0); } }

.subscription-item__details { flex-grow: 1; }
.subscription-item__name { font-weight: 700; font-size: 1.1rem; color: var(--color-text); display: block; margin-bottom: var(--space-xs); word-break: break-word; }
.subscription-item__info { font-size: 0.9rem; color: var(--color-text-muted); text-transform: capitalize; }
.subscription-item__info strong { color: var(--color-primary-accent); }

/* Action Buttons Container */
.subscription-item__actions {
    display: flex;
    gap: var(--space-sm);
    flex-shrink: 0; /* Prevent buttons shrinking */
}

/* Edit & Remove Buttons */
.subscription-item__edit-button,
.subscription-item__remove-button {
    color: var(--color-text); border: none; border-radius: var(--border-radius-sm);
    padding: var(--space-xs) var(--space-sm); height: var(--action-button-height);
    min-width: auto; display: inline-flex; align-items: center; justify-content: center;
    cursor: pointer; position: relative;
}
.subscription-item__edit-button .material-symbols-outlined,
.subscription-item__remove-button .material-symbols-outlined { font-size: 1.2rem; }
.subscription-item__edit-button:hover:not(:disabled),
.subscription-item__remove-button:hover:not(:disabled) { transform: scale(1.05); }
.subscription-item__edit-button:disabled,
.subscription-item__remove-button:disabled { background-color: var(--color-disabled); cursor: not-allowed; transform: none; }

/* Edit Button Specific */
.subscription-item__edit-button { background-color: var(--color-info); }
.subscription-item__edit-button:hover:not(:disabled) { background-color: var(--color-info-hover); }

/* Remove Button Specific */
.subscription-item__remove-button { background-color: var(--color-danger); }
.subscription-item__remove-button:hover:not(:disabled) { background-color: var(--color-danger-hover); }

/* Loader for action buttons */
.subscription-item__edit-button .form-button__loader,
.subscription-item__remove-button .form-button__loader { width: 16px; height: 16px; border-width: 2px; border-left-color: var(--color-text); }
.subscription-item__edit-button--loading .material-symbols-outlined,
.subscription-item__remove-button--loading .material-symbols-outlined { opacity: 0; visibility: hidden; }


/* --- Loading & Empty States --- */
.loading-indicator { /* ... (Same as previous page) ... */
    display: flex; align-items: center; justify-content: center; gap: var(--space-md);
    padding: var(--space-xl) 0; color: var(--color-text-muted); font-size: 1.1rem;
    transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease, height var(--transition-speed) ease;
    opacity: 1; visibility: visible; height: auto;
}
.loading-indicator--hidden { opacity: 0; visibility: hidden; height: 0; padding: 0; overflow: hidden; }
.loading-indicator__spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: var(--color-primary-accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-message { /* ... (Same as previous page) ... */
    text-align: center; color: var(--color-text-muted); padding: var(--space-xl);
    font-style: italic; font-size: 1rem; border-top: 1px dashed var(--color-border-subtle); margin-top: var(--space-lg);
}
.empty-message--hidden { display: none; }


/* --- Modal Styles (Consistent) --- */
.popup-overlay { /* ... (Same as previous page) ... */
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--color-overlay-bg); display: flex;
    justify-content: center; align-items: center; z-index: 1300;
    padding: var(--space-md); opacity: 1; visibility: visible;
    transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
}
.popup-overlay--hidden { opacity: 0; visibility: hidden; }
.popup { /* ... (Same as previous page) ... */
    background-color: var(--color-card-bg); padding: var(--space-xl);
    border-radius: var(--border-radius-md); width: 100%; max-width: 500px; /* Increased max-width slightly */
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4); position: relative; text-align: left;
    transform: scale(0.9); opacity: 0;
    animation: popupFadeIn 0.3s var(--transition-ease) forwards;
}
/* Edit modal specific styles */
.popup--edit { max-width: 550px; /* Slightly wider for form */ }
.popup--edit .popup__title { color: var(--color-primary-accent); /* Orange title for edit */ }
.popup--edit .popup__title .material-symbols-outlined { color: var(--color-primary-accent); } /* Orange icon */
.popup--edit form { display: flex; flex-direction: column; gap: var(--space-lg); }
.popup--edit .form-group { margin-bottom: 0; } /* Remove default margin if needed */

@keyframes popupFadeIn { to { transform: scale(1); opacity: 1; } }
.popup__close-button { /* ... (Same as previous page) ... */
    position: absolute; top: var(--space-sm); right: var(--space-sm);
    background: none; border: none; color: var(--color-text-muted);
    padding: var(--space-xs); cursor: pointer; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
}
.popup__close-button:hover { color: var(--color-text); background-color: rgba(255, 255, 255, 0.1); }
.popup__close-button .material-symbols-outlined { font-size: 1.5rem; }
.popup__title { /* ... (Same as previous page) ... */
    font-size: 1.5rem; margin-bottom: var(--space-lg); text-align: center;
    color: var(--color-text); display: flex; align-items: center; justify-content: center; gap: var(--space-sm);
}
.popup__title .material-symbols-outlined { font-size: 1.8rem; }
.popup__content { margin-bottom: var(--space-xl); }
#confirmation-message { color: var(--color-text); text-align: center; font-size: 1.1rem; margin-bottom: var(--space-md);}
.confirmation-details { /* ... (Same as previous page) ... */
    font-size: 0.95rem; color: var(--color-text-muted); background-color: var(--color-input-bg);
    padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-sm);
    border: 1px solid var(--color-border-subtle); text-align: center;
}
.confirmation-details strong { color: var(--color-text); }
.popup__actions { /* ... (Same as previous page) ... */
    display: flex; justify-content: flex-end; gap: var(--space-md); margin-top: var(--space-lg);
}
.popup__actions .form-button { min-width: 120px; height: var(--button-height); font-size: 1rem; border-radius: var(--border-radius-lg); } /* Consistent button style */
.form-button--secondary { /* ... (Same as previous page) ... */
    background-color: transparent; border: 2px solid var(--color-border-subtle); color: var(--color-text-muted);
}
.form-button--secondary:hover:not(:disabled) { border-color: var(--color-text); color: var(--color-text); background-color: rgba(255, 255, 255, 0.05); box-shadow: none; }
.form-button--secondary:active:not(:disabled) { background-color: rgba(255, 255, 255, 0.1); }
.form-button--danger { /* ... (Same as previous page) ... */
    background-color: var(--color-danger); color: var(--color-text);
}
.form-button--danger:hover:not(:disabled) { background-color: var(--color-danger-hover); box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3); }
/* Loader styles */
.popup__actions .form-button__loader { border-left-color: var(--color-text); } /* White loader on danger bg */
.popup__actions .form-button--secondary .form-button__loader { border-left-color: var(--color-text-muted); }
/* Edit modal save button uses primary accent */
#edit-popup-save-button { background-color: var(--color-primary-accent); color: var(--color-background); }
#edit-popup-save-button:hover:not(:disabled) { background-color: var(--color-primary-accent-hover); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 155, 7, 0.3); }
#edit-popup-save-button .form-button__loader { border-left-color: var(--color-background); } /* Dark loader */


/* Form element base styles */
.form-input, .form-select { /* ... (Same as settings) ... */
    width: 100%; padding: 0 var(--space-md); height: var(--input-height); line-height: var(--input-height);
    border: 1px solid var(--color-border-subtle); border-radius: var(--border-radius-md);
    color: var(--color-text); background-color: var(--color-input-bg); font-size: 1rem;
    transition: border-color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
}
.form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary-accent); box-shadow: 0 0 0 3px rgba(255, 155, 7, 0.3); }
.form-input::placeholder { color: var(--color-text-muted); opacity: 0.8; }
/* Button base styles */
.form-button { /* ... (Same as settings, but default align-self:stretch might be better) ... */
    height: var(--button-height); padding: 0 var(--space-lg); background-color: var(--color-primary-accent);
    color: var(--color-background); font-weight: 700; font-size: 1rem; border: none; cursor: pointer;
    border-radius: var(--border-radius-lg); display: inline-flex; align-items: center; justify-content: center;
    gap: var(--space-sm); position: relative;
}
.form-button:hover:not(:disabled) { background-color: var(--color-primary-accent-hover); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 155, 7, 0.3); }
.form-button:active:not(:disabled) { transform: translateY(0); box-shadow: none; }
.form-button:disabled, .form-button--loading { background-color: var(--color-disabled); color: rgba(255, 255, 255, 0.7); cursor: not-allowed; transform: none; box-shadow: none; }
/* Loader */
.form-button__text { transition: opacity 0.2s ease; }
.form-button__loader { position: absolute; width: 20px; height: 20px; border: 3px solid rgba(0, 0, 0, 0.3); border-left-color: var(--color-background); border-radius: 50%; opacity: 0; visibility: hidden; animation: spin 0.8s linear infinite; transition: opacity 0.2s ease, visibility 0.2s ease; }
.form-button--loading .form-button__text { opacity: 0; visibility: hidden; }
.form-button--loading .form-button__loader { opacity: 1; visibility: visible; }
/* Error message */
.form-error { color: var(--color-error); font-size: 0.9rem; min-height: 1.2em; margin-top: var(--space-xs); text-align: left; opacity: 1; transition: opacity var(--transition-speed) ease; }
.form-error--hidden { opacity: 0; }


/* --- Responsive Design --- */
@media screen and (max-width: 817px) {
   .header__menu-toggle { display: block; }
   .header__title { font-size: 1.25rem; }
   .header__version-badge { display: none; }
   .sidebar { transform: translateX(-100%); z-index: 1100; padding-top: var(--space-lg); height: 100vh; top: 0; }
   .sidebar--active { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
   .main-content { margin-left: 0; padding: var(--space-lg); }
   .page-title { font-size: 1.75rem; }
   .settings-card { padding: var(--space-lg); }
   .settings-card__title { font-size: 1.3rem; }
   .form-row { flex-direction: column; gap: var(--space-lg); } /* Stack form groups */
   .form-group--half { flex-basis: auto; } /* Reset basis */
   .add-subscription-form .form-button { align-self: stretch; } /* Full width button */
   .subscription-item { flex-direction: column; align-items: flex-start; gap: var(--space-sm); }
   .subscription-item__actions { align-self: flex-end; } /* Buttons to right */
   .popup { max-width: 90%; padding: var(--space-lg); }
   .popup__title { font-size: 1.3rem; }
   .popup__actions { flex-direction: column-reverse; gap: var(--space-sm); } /* Stack buttons */
   .popup__actions .form-button { width: 100%; }
}

</style>
<script>
// subscription-manager_gamma.js

// --- Utility function to get a cookie value by name ---
function getCookie(cname) {
    const name = cname + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') { c = c.substring(1); }
        if (c.indexOf(name) === 0) { return c.substring(name.length, c.length); }
    }
    return "";
}

// --- DOM Element Selectors ---
const menuToggle = document.getElementById('menu-toggle');
const sidebar = document.getElementById('sidebar');
const signInButton = document.getElementById('signin-button'); // Sidebar button
// Add Form
const addSubscriptionForm = document.getElementById('add-subscription-form');
const subNameInput = document.getElementById('sub-name');
const subPriceInput = document.getElementById('sub-price');
const subFrequencyInput = document.getElementById('sub-frequency');
const frequencyDetailsContainer = document.getElementById('frequency-details-container');
const subDetailDateInput = document.getElementById('sub-detail-date');
const subDetailDowSelect = document.getElementById('sub-detail-dow');
const subDetailDomInput = document.getElementById('sub-detail-dom');
const addSubscriptionButton = document.getElementById('add-subscription-button');
const addSubscriptionError = document.getElementById('add-subscription-error');
// List
const loadingIndicator = document.getElementById('loading-indicator');
const subscriptionListContainer = document.getElementById('subscription-list-container');
const emptyMessage = document.getElementById('empty-message');
// Remove Modal Selectors
const removeConfirmationOverlay = document.getElementById('remove-confirmation-overlay');
const removeConfirmationPopup = document.getElementById('remove-confirmation-popup');
const removeConfirmationTitle = document.getElementById('remove-confirmation-title');
const removeConfirmationMessage = document.getElementById('remove-confirmation-message');
const removeConfirmationDetails = document.getElementById('remove-confirmation-details');
const removeConfirmationCancelButton = document.getElementById('remove-confirmation-cancel-button');
const removeConfirmationCancelButtonAlt = document.getElementById('remove-confirmation-cancel-button-alt');
const removeConfirmationProceedButton = document.getElementById('remove-confirmation-proceed-button');
// Edit Modal Selectors
const editSubscriptionOverlay = document.getElementById('edit-subscription-overlay');
const editSubscriptionPopup = document.getElementById('edit-subscription-popup');
const editSubscriptionForm = document.getElementById('edit-subscription-form');
const editPopupCloseButton = document.getElementById('edit-popup-close-button');
const editSubOriginalNameInput = document.getElementById('edit-sub-original-name');
const editSubNameInput = document.getElementById('edit-sub-name');
const editSubPriceInput = document.getElementById('edit-sub-price');
const editSubFrequencyInput = document.getElementById('edit-sub-frequency');
const editFrequencyDetailsContainer = document.getElementById('edit-frequency-details-container');
const editSubDetailDateInput = document.getElementById('edit-sub-detail-date');
const editSubDetailDowSelect = document.getElementById('edit-sub-detail-dow');
const editSubDetailDomInput = document.getElementById('edit-sub-detail-dom');
const editSubscriptionError = document.getElementById('edit-subscription-error');
const editPopupCancelButton = document.getElementById('edit-popup-cancel-button');
const editPopupSaveButton = document.getElementById('edit-popup-save-button');
// Audio Selectors
const successAudio = document.getElementById('success-audio');
const failAudio = document.getElementById('fail-audio');


// --- Global State ---
let currentUserHash = null;
let currentRemoveActionData = null; // Store { subscriptionName } for remove action
let userCurrencySymbol = '$'; // Default values, fetched later
let userCurrencyAfter = false;
let allSubscriptionsCache = []; // Cache fetched subscriptions

// --- Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
    console.log("Subscription Manager DOM Loaded.");
    currentUserHash = checkAuthAndSetupUI();
    if (!currentUserHash) return; // Stop if not authenticated

    await loadUserPreferences(currentUserHash); // Fetch currency
    addEventListeners(currentUserHash);
    updateFrequencyDetailsVisibility(subFrequencyInput, frequencyDetailsContainer); // Initial visibility for Add form
    await renderSubscriptions(currentUserHash); // Initial render

    console.log("Subscription Manager Page Initialized.");
});

/** Checks authentication, sets up basic UI state */
function checkAuthAndSetupUI() {
    const userHash = getCookie('hash');
    if (!userHash) {
        console.log("User not authenticated. Redirecting to sign-in.");
        window.location.href = '../sign-in';
        return null;
    }
    if (signInButton) signInButton.style.display = 'none';
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 7);
    document.cookie = `hash=${userHash}; path=/; expires=${expiryDate.toUTCString()}; SameSite=Lax`;
    return userHash;
}

/** Loads user currency */
async function loadUserPreferences(userHash) {
     if (typeof DB === 'undefined' || !DB.u) { console.error("DB object not found."); return; }
    try {
        const user = await DB.u.get(userHash);
        if (user) {
            userCurrencySymbol = user.currency?.includes('*') ? '' : (user.currency || '$');
            userCurrencyAfter = user.currency?.includes('*') ? user.currency.replace('*', '') : '';
            console.log("User currency loaded:", userCurrencySymbol, userCurrencyAfter);
        } else { console.warn("User data not found for currency."); }
    } catch (error) { console.error("Error loading user preferences:", error); }
}


/** Adds all necessary event listeners */
function addEventListeners(userHash) {
    // Sidebar Toggle
    menuToggle?.addEventListener('click', () => sidebar?.classList.toggle('sidebar--active'));
    document.addEventListener('click', (event) => { /* ... (sidebar closing logic) ... */
        if (window.innerWidth <= 817) { const isClickInsideSidebar = sidebar?.contains(event.target); const isClickOnMenuToggle = menuToggle?.contains(event.target); if (!isClickInsideSidebar && !isClickOnMenuToggle && sidebar?.classList.contains('sidebar--active')) { sidebar.classList.remove('sidebar--active'); } }
    });

    // Frequency Select Change (Add Form)
    subFrequencyInput?.addEventListener('change', () => updateFrequencyDetailsVisibility(subFrequencyInput, frequencyDetailsContainer));
    // Frequency Select Change (Edit Form)
    editSubFrequencyInput?.addEventListener('change', () => updateFrequencyDetailsVisibility(editSubFrequencyInput, editFrequencyDetailsContainer));


    // Add Subscription Form Submission
    addSubscriptionForm?.addEventListener('submit', (e) => handleAddSubscription(e, userHash));

    // Edit Subscription Form Submission
    editSubscriptionForm?.addEventListener('submit', (e) => handleEditSubscriptionSave(e, userHash));


    // List Button Clicks (Event Delegation)
    subscriptionListContainer?.addEventListener('click', (event) => {
        const removeButton = event.target.closest('.subscription-item__remove-button');
        const editButton = event.target.closest('.subscription-item__edit-button');

        if (removeButton && !removeButton.disabled) {
            const subscriptionName = removeButton.dataset.subscriptionName;
            if (subscriptionName) {
                showRemoveConfirmationModal({ subscriptionName });
            } else { console.error("Missing subscription name data on remove button."); }
        } else if (editButton && !editButton.disabled) {
             const subscriptionName = editButton.dataset.subscriptionName;
             if (subscriptionName) {
                 // Find the full subscription data from cache to pre-fill the form
                 const subData = allSubscriptionsCache.find(sub => sub.name === subscriptionName);
                 if (subData) {
                     showEditSubscriptionPopup(subData);
                 } else {
                     console.error("Could not find subscription data in cache for:", subscriptionName);
                     alert("Error: Could not load subscription details for editing.");
                 }
             } else { console.error("Missing subscription name data on edit button."); }
        }
    });

    // Remove Modal Buttons
    removeConfirmationCancelButton?.addEventListener('click', hideRemoveConfirmationModal);
    removeConfirmationCancelButtonAlt?.addEventListener('click', hideRemoveConfirmationModal);
    removeConfirmationProceedButton?.addEventListener('click', handleRemoveProceedAction);

    // Edit Modal Buttons
    editPopupCloseButton?.addEventListener('click', hideEditSubscriptionPopup);
    editPopupCancelButton?.addEventListener('click', hideEditSubscriptionPopup);


    // Shortcut keys
    document.addEventListener('keydown', handleShortcuts);
}

// --- UI Update Functions ---

/** Updates visibility of frequency-specific input fields for a given form */
function updateFrequencyDetailsVisibility(frequencySelect, detailsContainer) {
    const selectedFrequency = frequencySelect?.value;
    if (!detailsContainer) return;

    // Remove all show classes first
    detailsContainer.classList.remove(
        'frequency-details--show-weekly',
        'frequency-details--show-monthly',
        'frequency-details--show-yearly'
    );
    // Hide all detail divs initially
    detailsContainer.querySelectorAll('.frequency-detail').forEach(el => el.style.display = 'none');


    // Add the specific class and show the correct div
    const detailToShow = detailsContainer.querySelector(`.frequency-detail--${selectedFrequency}`);
    if (detailToShow) {
        detailsContainer.classList.add(`frequency-details--show-${selectedFrequency}`);
        detailToShow.style.display = 'block'; // Ensure it's visible
    }
}

/** Sets the loading state for the subscription list */
function setListLoadingState(isLoading) { /* ... (same as previous) ... */
    if (isLoading) { loadingIndicator?.classList.remove('loading-indicator--hidden'); subscriptionListContainer.innerHTML = ''; emptyMessage?.classList.add('empty-message--hidden'); }
    else { loadingIndicator?.classList.add('loading-indicator--hidden'); }
}

/** Shows or hides the empty message */
function showEmptyMessage(show) { /* ... (same as previous) ... */
     if(show) { emptyMessage?.classList.remove('empty-message--hidden'); }
     else { emptyMessage?.classList.add('empty-message--hidden'); }
}

/** Formats a number as currency */
function formatCurrency(amount, symbol, symbolAfter) { /* ... (same as previous) ... */
    const num = Number(amount); if (isNaN(num)) return 'N/A'; const formattedAmount = num.toFixed(2); const displaySymbol = symbolAfter ? ` ${symbolAfter}` : symbol; return symbolAfter ? `${formattedAmount}${displaySymbol}` : `${displaySymbol}${formattedAmount}`;
}

// --- Subscription Rendering ---
/** Fetches and renders the list of subscriptions */
async function renderSubscriptions(userHash) {
    if (!userHash) return;
    setListLoadingState(true);

    if (typeof DB === 'undefined' || !DB.uDoc) {
        console.error('Firestore DB object or DB.uDoc not found.');
        setListLoadingState(false); showEmptyMessage(true); emptyMessage.textContent = "Error loading subscriptions."; return;
    }

    try {
        const subscriptions = await DB.uDoc.allDocs(userHash, 'subscriptions');
        allSubscriptionsCache = subscriptions || []; // Update cache
        console.log("Fetched subscriptions:", allSubscriptionsCache);

        subscriptionListContainer.innerHTML = ''; // Clear previous list

        if (allSubscriptionsCache.length === 0) {
            showEmptyMessage(true); emptyMessage.textContent = "You haven't added any subscriptions yet.";
        } else {
            showEmptyMessage(false);
            allSubscriptionsCache.sort((a, b) => a.name.localeCompare(b.name)); // Sort cache
            allSubscriptionsCache.forEach(sub => createSubscriptionItem(sub)); // Render from cache
        }

    } catch (error) {
        console.error("Error fetching subscriptions:", error);
        subscriptionListContainer.innerHTML = ''; showEmptyMessage(true); emptyMessage.textContent = `Error loading subscriptions: ${error.message}`;
    } finally {
        setListLoadingState(false);
    }
}

/** Creates and appends a subscription list item */
function createSubscriptionItem(sub) {
    const item = document.createElement('div');
    item.className = 'subscription-item';

    const detailsDiv = document.createElement('div');
    detailsDiv.className = 'subscription-item__details';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'subscription-item__name';
    nameSpan.textContent = sub.name || 'Unnamed Subscription';

    const infoSpan = document.createElement('span');
    infoSpan.className = 'subscription-item__info';
    const formattedPrice = formatCurrency(sub.price, userCurrencySymbol, userCurrencyAfter);
    let freqDetail = sub.freq_value;
    if (sub.frequency === 'yearly' && Array.isArray(sub.freq_value)) {
        try { const date = new Date(2000, sub.freq_value[1] - 1, sub.freq_value[0]); freqDetail = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } catch {}
    } else if (sub.frequency === 'monthly') { freqDetail = `Day ${sub.freq_value}`; }
    infoSpan.innerHTML = `<strong>${formattedPrice}</strong> / ${sub.frequency} (${freqDetail})`;

    detailsDiv.appendChild(nameSpan);
    detailsDiv.appendChild(infoSpan);

    // Action Buttons Container
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'subscription-item__actions';

    // Edit Button
    const editButton = document.createElement('button');
    editButton.type = 'button';
    editButton.className = 'subscription-item__edit-button';
    editButton.title = `Edit subscription: ${sub.name}`;
    editButton.dataset.subscriptionName = sub.name;
    // Store all data needed for pre-filling the edit form
    editButton.dataset.price = sub.price;
    editButton.dataset.frequency = sub.frequency;
    editButton.dataset.freqValue = JSON.stringify(sub.freq_value); // Store complex values as JSON string
    editButton.innerHTML = `<span class="material-symbols-outlined">edit</span>`;
    actionsDiv.appendChild(editButton);

    // Remove Button
    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'subscription-item__remove-button';
    removeButton.title = `Remove subscription: ${sub.name}`;
    removeButton.dataset.subscriptionName = sub.name;
    removeButton.innerHTML = `
        <span class="material-symbols-outlined">delete</span>
        <span class="form-button__loader"></span>`;
    actionsDiv.appendChild(removeButton);


    item.appendChild(detailsDiv);
    item.appendChild(actionsDiv); // Add actions container

    subscriptionListContainer.appendChild(item);
}

// --- Add Subscription Logic ---
/** Handles the submission of the add subscription form */
async function handleAddSubscription(event, userHash) {
    event.preventDefault();
    clearError(addSubscriptionError);

    // 1. Get Base Values & Frequency Specific Value
    const name = subNameInput.value.trim();
    const price = parseFloat(subPriceInput.value.trim());
    const frequency = subFrequencyInput.value;
    let freqValue;
    let validationError = null;

    if (frequency === 'weekly') {
        freqValue = subDetailDowSelect.value;
        if (!freqValue) validationError = "Please select a day of the week.";
    } else if (frequency === 'monthly') {
        freqValue = parseInt(subDetailDomInput.value, 10);
        if (isNaN(freqValue) || freqValue < 1 || freqValue > 31) validationError = "Please enter a valid day of the month (1-31).";
    } else if (frequency === 'yearly') {
        const dateValue = subDetailDateInput.value; // YYYY-MM-DD
        if (!dateValue) { validationError = "Please select a date for yearly frequency."; }
        else {
            const dateParts = dateValue.split('-');
            if (dateParts.length !== 3) { validationError = "Invalid date format selected."; }
            else {
                freqValue = [parseInt(dateParts[2]), parseInt(dateParts[1])]; // [Day, Month]
                if (isNaN(freqValue[0]) || isNaN(freqValue[1])) validationError = "Invalid date parsed.";
            }
        }
    } else { validationError = "Invalid frequency selected."; }

    // 2. Final Validation
    if (validationError) { displayError(addSubscriptionError, validationError); return; }
    if (!name) { displayError(addSubscriptionError, "Subscription name cannot be empty."); return; }
    if (isNaN(price) || price <= 0) { displayError(addSubscriptionError, "Please enter a valid positive amount."); return; }
    if (allSubscriptionsCache.some(sub => sub.name.toLowerCase() === name.toLowerCase())) {
         displayError(addSubscriptionError, `A subscription named "${name}" already exists.`); return;
    }

    // 3. Prepare & Add to DB
    const newSubscription = { name, price, frequency, freq_value: freqValue };
    setButtonLoading(addSubscriptionButton, true);
    try {
        if (typeof DB === 'undefined' || !DB.uDoc) throw new Error("Database connection not available.");
        await DB.uDoc.newDoc(userHash, 'subscriptions', newSubscription.name, newSubscription);
        console.log("Subscription added:", newSubscription);
        successAudio?.play();
        addSubscriptionForm.reset(); // Clear form
        updateFrequencyDetailsVisibility(subFrequencyInput, frequencyDetailsContainer); // Reset visibility
        await renderSubscriptions(userHash); // Refresh list
    } catch (error) {
        console.error("Error adding subscription:", error);
        displayError(addSubscriptionError, `Failed to add subscription: ${error.message || 'Please try again.'}`);
        failAudio?.play();
    } finally {
        setButtonLoading(addSubscriptionButton, false);
    }
}


// --- Remove Subscription Logic ---
/** Core logic to delete a subscription */
async function deleteSubscription(subscriptionName, userHash) {
    console.log(`Attempting removal of subscription: ${subscriptionName}`);
    if (typeof DB === 'undefined' || !DB.uDoc) throw new Error("Database connection not available.");
    await DB.uDoc.deleteDoc(userHash, 'subscriptions', subscriptionName);
    console.log(`Subscription ${subscriptionName} deleted from DB.`);
    // Remove from cache
    allSubscriptionsCache = allSubscriptionsCache.filter(sub => sub.name !== subscriptionName);
    return true; // Indicate success
}


// --- Edit Subscription Logic ---
/** Shows the edit subscription popup and pre-fills the form */
function showEditSubscriptionPopup(subscriptionData) {
     if (!editSubscriptionOverlay || !subscriptionData) return;

     console.log("Populating edit form for:", subscriptionData.name);

     // Store original name (used as ID)
     editSubOriginalNameInput.value = subscriptionData.name;

     // Populate fields
     editSubNameInput.value = subscriptionData.name;
     editSubPriceInput.value = subscriptionData.price;
     editSubFrequencyInput.value = subscriptionData.frequency;

     // Populate frequency-specific field
     const freq = subscriptionData.frequency;
     const freqVal = subscriptionData.freq_value;
     if (freq === 'weekly') {
         editSubDetailDowSelect.value = freqVal;
     } else if (freq === 'monthly') {
         editSubDetailDomInput.value = freqVal;
     } else if (freq === 'yearly' && Array.isArray(freqVal)) {
         // Need to format as YYYY-MM-DD for the date input
         // We don't have the year, so use a placeholder like current year
         const currentYear = new Date().getFullYear();
         const month = String(freqVal[1]).padStart(2, '0');
         const day = String(freqVal[0]).padStart(2, '0');
         editSubDetailDateInput.value = `${currentYear}-${month}-${day}`;
     }

     // Update visibility of frequency details in the modal
     updateFrequencyDetailsVisibility(editSubFrequencyInput, editFrequencyDetailsContainer);

     // Clear any previous errors and show modal
     clearError(editSubscriptionError);
     editSubscriptionOverlay.classList.remove('popup-overlay--hidden');
}

/** Hides the edit subscription popup */
function hideEditSubscriptionPopup() {
    editSubscriptionOverlay?.classList.add('popup-overlay--hidden');
    setButtonLoading(editPopupSaveButton, false); // Reset button state
}

/** Handles saving changes from the edit subscription modal */
async function handleEditSubscriptionSave(event, userHash) {
    event.preventDefault();
    clearError(editSubscriptionError);
    let freqValue;

    // 1. Get Original Name and New Values
    const originalName = editSubOriginalNameInput.value;
    const newName = editSubNameInput.value.trim();
    const newPrice = parseFloat(editSubPriceInput.value.trim());
    const newFrequency = editSubFrequencyInput.value;

    // 2. Get Frequency-Specific Value & Validate
    let validationError = null;
    if (newFrequency === 'weekly') {
        freqValue = editSubDetailDowSelect.value;
        if (!freqValue) validationError = "Please select a day of the week.";
    } else if (newFrequency === 'monthly') {
        freqValue = parseInt(editSubDetailDomInput.value, 10);
        if (isNaN(freqValue) || freqValue < 1 || freqValue > 31) validationError = "Please enter a valid day of the month (1-31).";
    } else if (newFrequency === 'yearly') {
        const dateValue = editSubDetailDateInput.value;
        if (!dateValue) { validationError = "Please select a date for yearly frequency."; }
        else {
            const dateParts = dateValue.split('-');
            if (dateParts.length !== 3) { validationError = "Invalid date format selected."; }
            else {
                freqValue = [parseInt(dateParts[2]), parseInt(dateParts[1])]; // [Day, Month]
                 if (isNaN(freqValue[0]) || isNaN(freqValue[1])) validationError = "Invalid date parsed.";
            }
        }
    } else { validationError = "Invalid frequency selected."; }

    // 3. Final Validation
    if (validationError) { displayError(editSubscriptionError, validationError); return; }
    if (!newName) { displayError(editSubscriptionError, "Subscription name cannot be empty."); return; }
    if (isNaN(newPrice) || newPrice <= 0) { displayError(editSubscriptionError, "Please enter a valid positive amount."); return; }

    // Check for duplicate name ONLY if the name was changed
    if (newName.toLowerCase() !== originalName.toLowerCase() &&
        allSubscriptionsCache.some(sub => sub.name.toLowerCase() === newName.toLowerCase())) {
         displayError(editSubscriptionError, `A subscription named "${newName}" already exists.`);
         return;
    }

    // 4. Prepare Updated Data
    const updatedSubscriptionData = {
        name: newName, // Name might have changed
        price: newPrice,
        frequency: newFrequency,
        freq_value: freqValue
    };

    // 5. Update Database
    setButtonLoading(editPopupSaveButton, true);
    try {
        if (typeof DB === 'undefined' || !DB.uDoc) throw new Error("Database connection not available.");

        if (newName === originalName) {
            // Name hasn't changed, just update the existing document
            await DB.uDoc.updateDoc(userHash, 'subscriptions', originalName, updatedSubscriptionData);
            console.log("Subscription updated:", originalName, updatedSubscriptionData);
        } else {
            // Name HAS changed. Since name is the ID, we need to delete the old and add the new.
            // Use a transaction or batch write in production for atomicity if possible.
            console.log(`Subscription renamed from "${originalName}" to "${newName}". Recreating document...`);
            await DB.uDoc.deleteDoc(userHash, 'subscriptions', originalName);
            await DB.uDoc.newDoc(userHash, 'subscriptions', newName, updatedSubscriptionData);
            console.log("Subscription recreated with new name.");
        }

        successAudio?.play();
        hideEditSubscriptionPopup(); // Close modal on success
        await renderSubscriptions(userHash); // Refresh the list

    } catch (error) {
        console.error("Error updating subscription:", error);
        displayError(editSubscriptionError, `Failed to update subscription: ${error.message || 'Please try again.'}`);
        failAudio?.play();
    } finally {
        setButtonLoading(editPopupSaveButton, false);
    }
}


// --- Confirmation Modal Logic (for Remove) ---
/** Shows the confirmation modal */
function showRemoveConfirmationModal(data) {
    currentAction = 'remove-subscription'; // Set action type
    currentRemoveActionData = data; // Store data for removal
    console.log("Showing confirmation modal for action:", currentAction, currentRemoveActionData);

    if (!removeConfirmationOverlay || !removeConfirmationTitle || !removeConfirmationMessage || !removeConfirmationProceedButton || !removeConfirmationDetails) return;

    // Customize modal content
    if (data?.subscriptionName) {
        removeConfirmationTitle.innerHTML = `<span class="material-symbols-outlined">warning</span> Delete Subscription?`;
        removeConfirmationMessage.textContent = `Are you sure you want to permanently delete the subscription:`;
        removeConfirmationDetails.innerHTML = `<strong>${data.subscriptionName}</strong>`;
        removeConfirmationDetails.style.display = 'block';
        removeConfirmationProceedButton.classList.add('form-button--danger');
        removeConfirmationProceedButton.querySelector('.form-button__text').textContent = 'Delete Subscription';
    } else {
        // Fallback if data is missing
        removeConfirmationDetails.style.display = 'none';
        removeConfirmationMessage.textContent = "Are you sure?";
    }

    removeConfirmationOverlay.classList.remove('popup-overlay--hidden');
}

/** Hides the confirmation modal */
function hideRemoveConfirmationModal() {
    currentAction = null;
    currentRemoveActionData = null;
    removeConfirmationOverlay?.classList.add('popup-overlay--hidden');
    setButtonLoading(removeConfirmationProceedButton, false); // Reset proceed button state
    console.log("Remove confirmation modal hidden.");
}

/** Handles the 'Proceed' button click in the modal */
async function handleRemoveProceedAction() {
    if (currentAction !== 'remove-subscription' || !currentRemoveActionData?.subscriptionName || !currentUserHash) {
        console.error("Invalid action or data for proceed:", currentAction, currentRemoveActionData);
        hideRemoveConfirmationModal();
        return;
    }

    const subscriptionName = currentRemoveActionData.subscriptionName;
    const buttonToDisable = document.querySelector(`.subscription-item__remove-button[data-subscription-name="${subscriptionName}"]`);

    setButtonLoading(removeConfirmationProceedButton, true);
    if(buttonToDisable) setButtonLoading(buttonToDisable, true);

    try {
        await deleteSubscription(subscriptionName, currentUserHash);
        console.log("Subscription removal successful via modal.");
        successAudio?.play();
        hideRemoveConfirmationModal();
        await renderSubscriptions(currentUserHash); // Refresh the list
    } catch (error) {
        console.error("Proceed action failed:", error);
        failAudio?.play();
        alert(`Failed to delete subscription: ${error.message || 'Please try again.'}`);
        setButtonLoading(removeConfirmationProceedButton, false);
        if(buttonToDisable) setButtonLoading(buttonToDisable, false);
        hideRemoveConfirmationModal();
    }
}


// --- Utility Functions ---
/** Displays an error message */
function displayError(element, message, isError = true) { /* ... (same as previous) ... */
    if (!element) return; element.textContent = message; element.style.color = isError ? 'var(--color-error)' : 'var(--color-text-muted)'; element.classList.remove('form-error--hidden'); if (!isError) { setTimeout(() => { if (element.textContent === message) { clearError(element); } }, 3000); }
}
/** Clears a specific error message */
function clearError(element) { /* ... (same as previous) ... */
     if(element) { element.textContent = ''; element.classList.add('form-error--hidden'); }
}
/** Sets the loading state of a button */
function setButtonLoading(button, isLoading) { /* ... (same as previous) ... */
    if (!button) return; const textSpan = button.querySelector('.form-button__text'); const iconSpan = button.querySelector('.material-symbols-outlined'); if (isLoading) { button.disabled = true; button.classList.add('form-button--loading'); if (textSpan) textSpan.style.visibility = 'hidden'; if (iconSpan) iconSpan.style.visibility = 'hidden'; } else { button.disabled = false; button.classList.remove('form-button--loading'); if (textSpan) textSpan.style.visibility = 'visible'; if (iconSpan) iconSpan.style.visibility = 'visible'; }
}
/** Handles shortcut keys */
function handleShortcuts(event) { /* ... (same as previous) ... */
     if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || !removeConfirmationOverlay?.classList.contains('popup-overlay--hidden') || !editSubscriptionOverlay?.classList.contains('popup-overlay--hidden')) { return; } const shortcuts = { 'D': '../dashboard', 'R': '../add-receipt', 'V': '../report', 'P': '../printout', 'L': '../links' }; if (event.shiftKey && shortcuts[event.key.toUpperCase()]) { window.location.href = shortcuts[event.key.toUpperCase()]; }
}
</script>